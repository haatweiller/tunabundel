%%
%% This file tunaChords.sty 
%% is writen by Michael Heidweiller for
%% The tuna bundle
%% date of last modification 4-10-2015
%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{tunaChords}

\RequirePackage[a4paper, portrait]{geometry}
\RequirePackage{fancyhdr}
\RequirePackage[T1]{fontenc}
\RequirePackage{paralist}
\RequirePackage{tabularx}
\RequirePackage{suffix}
\RequirePackage{tocloft}
\RequirePackage{color}
\RequirePackage[usenames,dvipsnames]{xcolor}
\RequirePackage[spanish]{babel}
\RequirePackage{units}
\RequirePackage{marginnote}
\RequirePackage{changepage}
\RequirePackage{ifthen}
\RequirePackage[utf8]{inputenc}
\RequirePackage{xparse}
\RequirePackage{etoolbox}
\RequirePackage[nomessages]{fp}
\RequirePackage{float}
\RequirePackage{colortbl}
\RequirePackage{comment}

%%%% Options
\newif\ifshowtranslation\showtranslationfalse
\DeclareOption{notranslation}{\showtranslationfalse}
\DeclareOption{translation}{\showtranslationtrue}

\newif\if@nocolor\@nocolorfalse
\DeclareOption{color}{
	\definecolor{default}{rgb}{1.0,0,0}
	\@nocolorfalse
}

\DeclareOption{bw}{
	\definecolor{default}{rgb}{0,0,0}
	\@nocolortrue
}

\ExecuteOptions{color,translation}
\ProcessOptions\relax

%% counters
\newcounter{songs}
\setcounter{songs}{1}
\newcounter{measures}

%% lenghts

%pagestyle
\newlength{\vindent}
\setlength{\vindent}{-1.5em}
\newlength{\instrumentalwidth}
\setlength{\instrumentalwidth}{330pt}
\setlength{\parskip}{3ex}
\setlength{\parindent}{0pt}
\setlength{\textheight}{674pt}
\setlength{\textwidth}{426pt}
\setlength{\headheight}{30.2pt}
\setlength{\headsep}{2ex}
\setlength{\voffset}{0pt}
\setlength{\topmargin}{-25pt}
\setlength{\marginparwidth}{5em}
%\setlength{\headwidth}{0.75\paperwidth}
\setlength{\hoffset}{0pt}
\setlength{\marginparsep}{1em}

\newlength{\myoddoffset}
\setlength{\myoddoffset}{\marginparwidth plus \marginparsep}

\setlength{\arrayrulewidth}{1pt}

\makeatletter
\newcommand*{\stripunit}[1]{\strip@pt#1}
\makeatother

% song header added to TOC and with number
\DeclareDocumentEnvironment{song}{s O{default} m} {%
	\IfBooleanTF{#1}{}{
		\addcontentsline{toc}{section}{\if@nocolor
			\arabic{songs}. #3
		\else
			\textcolor{#2}{\arabic{songs}. #3}
		\fi}}
	\vspace{-12pt}
	
	% rhythm command
	\DeclareDocumentCommand\rhythmandkey{O{\nicefrac{2}{4}} m m} {%
		\rmfamily
		\vspace{-12pt}\hspace{-12pt}%
		\scriptsize%
		(\emph{\textbf{##1} ##2} in ##3)\par%
		\normalsize\normalfont}

	\DeclareDocumentCommand\chord{s m}{%
		\IfBooleanTF{##1}{\footnotesize\textbf{##2}\normalsize}{%
			\makebox[0pt][l]{\begin{tabular}[b]{@{}l@{}}\footnotesize\textbf{##2}\\			\mbox{}\end{tabular}}\normalsize}%
		}
	
	%verse command
	\DeclareDocumentEnvironment{verse}{m}{%
		{\vspace{12pt}\hspace{-12pt}\makebox[0pt][l]{\textbf{##1}}\vspace{-24pt}}
		\list{}{\addtolength{\leftmargin}{\vindent}}%
			\item[]%
	}{\endlist}
	%instrumental command	
	\DeclareDocumentEnvironment{instrumental}{m}{%
		\FPeval\witdhdim{\stripunit\instrumentalwidth / 8}%
		\setcounter{measures}{0}
		\hspace{-12pt}\textbf{##1}\\
		\begin{tabular}[!htbp]{| p{\witdhdim pt} | *{7}{p{\witdhdim pt} |}}%
	}{\end{tabular}}
	
	\DeclareDocumentCommand{\measure}{s o >{\SplitList{;}}m o}{%
		\IfNoValueF{##2}{\hspace{-4pt}\textbf{##2}}
		\ProcessList{##3}{ \insertitem }%
		\IfNoValueF{##4}{\textbf{##4}}
		\stepcounter{measures}%
		\IfBooleanF{##1}{
			\ifnumequal{\themeasures}{8}{%
				\\\arrayrulecolor{white}\hline\arrayrulecolor{black}%
				\setcounter{measures}{0}%
			}{&}%
		}
	}%
	\DeclareDocumentCommand\insertitem{m}{\footnotesize\textbf{##1}\normalsize\hfill}%
	
	\begin{center}%
	\LARGE %
	\if@nocolor
		\IfBooleanTF{#1}{}{\arabic{songs}. }\textbf{#3}
	\else
		\textcolor{#2}{\IfBooleanTF{#1}{}{\arabic{songs}. } \textbf{#3}}
	\fi
	\end{center}
	
}{\IfBooleanTF{#1}{}{\stepcounter{songs}}\clearpage}

\ifshowtranslation
  \DeclareDocumentEnvironment{translation}{s}{\textbf{Vertaling:}\\}{\IfBooleanTF{#1}{\cleardoublepage}{\clearpage}}
\else
  \excludecomment{translation}
\fi

% lijn bij header
\renewcommand{\headrulewidth}{1.8pt}
\makeatletter
\renewcommand{\headrule}{
	\setlength\@tempdima{0pt}
	\addtolength{\@tempdima}{\headwidth}
	\textcolor{default}{\hspace{-100pt},\hrule\@height\headrulewidth\@width\@tempdima}
	\textcolor{black}{\hrule\@height\headrulewidth\@width\@tempdima}
	\textcolor{default}{\hrule\@height\headrulewidth\@width\@tempdima}
}
\makeatother

% lijn bij footer
\renewcommand{\footrulewidth}{0.9pt}
\makeatletter
\renewcommand{\footrule}{
	\setlength\@tempdima{0pt}
	\addtolength{\@tempdima}{\headwidth}
	\textcolor{default}{\hrule\@height\footrulewidth\@width\@tempdima}
	\textcolor{black}{\hrule\@height\footrulewidth\@width\@tempdima}
	\textcolor{default}{\hrule\@height\footrulewidth\@width\@tempdima}
}
\makeatother

%header and foot text
\fancypagestyle{fancyplain}{
	\fancyhf{}
	\fancyheadoffset[leh,roh]{\myoddoffset}
	\fancyheadoffset[loh,reh]{\marginparsep}
	\fancyfootoffset[lef,rof]{\myoddoffset}
	\fancyfootoffset[lof,ref]{\marginparsep}
	\fancyhead[LE]{\hspace{2pt}\textbf{Cancions de Tuna}\hspace{2pt}}
	\fancyhead[RO]{\hspace{2pt}\textbf{Tuna Ciudad de Luz}\hspace{2pt}}
	\fancyfoot[LE,RO]{\hspace{2pt}\emph{\thepage}\hspace{2pt}}
}

\pagestyle{fancyplain}

% code for index page
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}

% commands for the font
\renewcommand*{\familydefault}{\sfdefault} %set to sans serif
\renewcommand*\sfdefault{phv}

\endinput